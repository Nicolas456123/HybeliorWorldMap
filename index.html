<html>
<head>
    <title>Hybelior World Map</title>
    <script src="./openseadragon-bin-5.0.0/openseadragon.min.js"></script>
    <script src="./openseadragon-bin-5.0.0/openseadragon-svg-overlay.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* Importation de la police Copperplate-Gothic-Std-29-AB */
        @font-face {
            font-family: 'Copperplate Gothic Std';
            src: url('./Font/Copperplate-Gothic-Std-33-BC.ttf') format('truetype');
        }

        /* Style pour les boutons */
        .controls {
            position: absolute;
            top: 100px;
            left: 10px;
            z-index: 1000;
        }
        .controls button {
            display: block;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .controls button:hover {
            background-color: #0056b3;
        }

        /* Style pour la fenêtre d'information */
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            height: auto;
            padding: 15px;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            font-family: 'Copperplate Gothic Std', sans-serif;
            display: none; /* Caché par défaut */
            z-index: 1001; /* S'assurer que la fenêtre est au-dessus des autres éléments */
        }

        .info-panel h2 {
            margin-top: 0;
            font-size: 20px;
            color: #333;
        }

        .info-panel p {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>

<body>
<div id="openseadragon1" style="width: calc(100% - 20px); height: calc(100% - 20px); position: relative;">
    <!-- Boutons de contrôle -->
    <div class="controls">
        <button id="toggleText">Toggle Text</button>
    </div>

    <!-- Fenêtre d'information pour afficher les détails de la ville -->
    <div id="infoPanel" class="info-panel">
        <span id="closeInfoPanel" style="position:absolute; top:10px; right:10px; cursor:pointer; font-weight:bold;">&times;</span>
        <h2 id="cityName">Nom de la ville</h2>
        <p id="cityInfo">Texte placeholder pour l'information sur la ville...</p>
    </div>
</div>

<script type="text/javascript">
    var viewer = OpenSeadragon({
        id: "openseadragon1",
        prefixUrl: "./images/",
        tileSources: "./Hybelior100Dz.dzi"
    });
    
    document.getElementById('closeInfoPanel').addEventListener('click', function() {
        document.getElementById('infoPanel').style.display = 'none';
    });

    // Ajouter l'overlay SVG
    var svgOverlay = viewer.svgOverlay();

    var textElements = []; // Array pour stocker les éléments de texte

    // Fonction de conversion des coordonnées pour les adapter à OpenSeadragon
    function convertCoordinates(x, y) {
        return {
            x: (x + 525.8) / 1047,  // Ajustement des coordonnées
            y: (y + 532.8) / 1047
        };
    }

function addTextFromCSV(filePath, fontSize) {
    Papa.parse(filePath, {
        download: true,
        header: true,
        complete: function(results) {
            results.data.forEach(function(item) {
                var x = parseFloat(item.Coord_X);
                var y = parseFloat(item.Coord_Y);
				
				if (isNaN(x) || isNaN(y)) {
					console.error("Invalid coordinate:", x, y);
					return; // Ignorer cet élément si les coordonnées ne sont pas valides
				}
					
                var convertedCoord = convertCoordinates(x, y);
				
				if (isNaN(convertedCoord.x) || isNaN(convertedCoord.y)) {
					console.error("Converted coordinates are invalid:", convertedCoord);
					return; // Ignorer cet élément si les coordonnées converties ne sont pas valides
				}

                // Calcul dynamique de l'épaisseur du contour en fonction de la taille du texte
                var strokeWidth = fontSize * 0.06;
				
				// Création et configuration de l'élément texte SVG
                var textElement = document.createElementNS("http://www.w3.org/2000/svg", "text");
                textElement.setAttribute("x", convertedCoord.x);
                textElement.setAttribute("y", convertedCoord.y);
                textElement.setAttribute("fill", "white"); // Couleur du texte
                textElement.setAttribute("stroke", "black"); // Couleur du contour du texte
                textElement.setAttribute("stroke-width", strokeWidth); // Épaisseur du contour
                textElement.setAttribute("font-size", fontSize); // Taille de la police
                textElement.setAttribute("text-anchor", "middle"); // Centrage du texte
                textElement.setAttribute("font-family", "Copperplate Gothic Std, sans-serif"); // Police personnalisée
				textElement.setAttribute("pointer-events", "none");
                textElement.textContent = item[''];  // Texte provenant du CSV

                // Calcul de la largeur et de la hauteur du rectangle basé sur le texte
                var textWidth = item[''].length * fontSize * 0.6; // Ajustez selon votre police
                var textHeight = fontSize * 0.6; // Ajouter un peu de marge pour le texte

				// Création d'un groupe SVG pour contenir le texte et le rectangle
                //var groupElement = document.createElementNS("http://www.w3.org/2000/svg", "g");
                //groupElement.setAttribute("transform", "translate(" + convertedCoord.x + "," + convertedCoord.y + ")");

                // Création et configuration de l'élément rectangle SVG
                var rectElement = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rectElement.setAttribute("x", convertedCoord.x - textWidth / 2);
                rectElement.setAttribute("y", convertedCoord.y - textHeight);
                rectElement.setAttribute("width", textWidth);
                rectElement.setAttribute("height", textHeight);
                rectElement.setAttribute("fill", "transparent"); // Changez "none" à une couleur si vous voulez le voir
                rectElement.setAttribute("pointer-events", "all"); // Assure que le rect capte les événements de clic

                

                // Ajouter le rectangle et le texte au groupe
                //groupElement.appendChild(textElement);
				//groupElement.appendChild(rectElement);
				svgOverlay.node().appendChild(rectElement);

				svgOverlay.node().appendChild(textElement); // Le texte est ajouté avant le rect pour apparaître en-dessous
				
                // Ajouter un gestionnaire de clic uniquement au rectangle
                var tracker = new OpenSeadragon.MouseTracker({
                    element: rectElement,  // Événements de clic seulement sur le rectangle
                    clickHandler: function(event) {
                        event.preventDefaultAction = true; // Empêche le zoom
                        document.getElementById('cityName').textContent = item['']; // Nom de la ville
                        document.getElementById('cityInfo').textContent = "Texte placeholder pour " + item[''] + "."; // Texte placeholder
                        document.getElementById('infoPanel').style.display = 'block'; // Afficher la fenêtre d'information
                    }
                });

                tracker.setTracking(true);
				
				textElements.push(textElement);  // Stockage de l'élément texte
            });
        }
    });
}




    // Ajouter les villes, cités et villages avec des tailles de texte différentes
    addTextFromCSV("./Data/DT_Villes.csv", "0.0011");   // Texte pour les villes
    addTextFromCSV("./Data/DT_Cites.csv", "0.0015");    // Texte pour les cités
    addTextFromCSV("./Data/DT_Villages.csv", "0.0006"); // Texte pour les villages

    // Gestion des boutons pour activer/désactiver l'image et le texte
    document.getElementById('toggleText').addEventListener('click', function() {
        textElements.forEach(function(textElement) {
            if (textElement.style.display === 'none') {
                textElement.style.display = 'block';
            } else {
                textElement.style.display = 'none';
            }
        });
    });
</script>
</body>
</html>
